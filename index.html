<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AsyrafUwais PlayStation - Professional System v8.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Courier+Prime:wght@400;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ps-active {
            border-color: #3b82f6;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
        }

        .badge-ps3 { background-color: #ef4444; }
        .badge-ps4 { background-color: #3b82f6; }

        .argo-text {
            color: #10b981;
            text-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .receipt-paper {
            background-color: #ffffff;
            color: #000000;
            font-family: 'Courier Prime', monospace;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; color: #000 !important; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            @page { margin: 0; size: auto; }
            .no-print { display: none !important; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        table { width: 100%; border-collapse: collapse; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">

    <!-- Screen Login -->
    <div id="login-screen" class="fixed inset-0 z-[200] flex items-center justify-center bg-[#070b14] p-4">
        <div class="glass-card max-w-md w-full rounded-[2.5rem] p-12 text-center border border-white/5 shadow-2xl">
            <div class="bg-blue-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <h2 class="text-3xl font-extrabold mb-2 text-white uppercase">ADMIN LOGIN</h2>
            <p class="text-slate-500 mb-8 text-xs uppercase tracking-widest font-bold">AsyrafUwais PlayStation</p>
            
            <div class="space-y-4">
                <input type="password" id="login-pin" placeholder="PIN ANDA" class="w-full bg-slate-900 border border-white/10 rounded-2xl py-4 text-center text-3xl tracking-[0.5em] text-white outline-none focus:ring-2 focus:ring-blue-500 transition shadow-inner">
                <button id="btn-login-action" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-2xl transition shadow-lg active:scale-95 uppercase tracking-widest text-sm">Masuk</button>
            </div>
            <p id="login-error" class="text-rose-500 text-[10px] font-bold mt-6 hidden uppercase tracking-widest">Akses Ditolak: PIN Salah!</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <header class="sticky top-0 z-50 glass-card border-b border-white/10 px-6 py-4 mb-8 no-print">
            <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600 p-2.5 rounded-2xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold text-white tracking-tight">AsyrafUwais</h1>
                        <p class="text-[9px] text-slate-400 font-extrabold uppercase tracking-[0.2em]" id="user-info-display">Role: Guest</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button id="btn-open-settings" class="hidden px-5 py-2.5 bg-slate-800 rounded-xl hover:bg-slate-700 transition border border-white/5 text-[10px] font-bold uppercase tracking-widest text-white shadow-lg">⚙️ SETTING</button>
                    <button id="btn-logout-trigger" class="px-5 py-2.5 bg-rose-600/10 text-rose-500 border border-rose-500/20 rounded-xl text-[10px] font-bold hover:bg-rose-600 hover:text-white transition uppercase">Logout</button>
                    <div id="digital-clock" class="text-lg font-mono font-bold bg-slate-900/50 px-5 py-2.5 rounded-2xl border border-white/5 text-blue-400 min-w-[120px] text-center">00:00:00</div>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto px-6 grid grid-cols-1 lg:grid-cols-4 gap-10 no-print pb-24 text-white">
            <!-- Left Bar: UNIT CONSUL -->
            <div class="lg:col-span-3">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-black text-white uppercase tracking-tight flex items-center gap-3">
                        <span class="w-1.5 h-8 bg-blue-500 rounded-full shadow-[0_0_15px_rgba(59,130,246,0.5)]"></span>
                        UNIT CONSUL
                    </h2>
                    <div id="connection-label" class="px-4 py-1.5 bg-slate-800 rounded-full text-[9px] font-extrabold text-slate-400 border border-white/5 uppercase tracking-widest italic">Syncing Cloud...</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" id="stations-display-grid"></div>
            </div>

            <!-- Right Bar: MENU -->
            <div class="lg:col-span-1 space-y-10">
                <div class="glass-card rounded-[2.5rem] p-8 border border-white/5 shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 text-white uppercase flex items-center gap-3">
                        <span class="w-1.5 h-8 bg-orange-500 rounded-full shadow-[0_0_15px_rgba(249,115,22,0.5)]"></span> MENU
                    </h2>
                    <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar" id="menu-display-list"></div>
                </div>

                <div id="billing-summary-card" class="glass-card rounded-[2.5rem] p-8 border-t-4 border-emerald-500 hidden shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 text-emerald-400 uppercase tracking-widest text-center">TAGIHAN</h2>
                    <div id="summary-render-area" class="space-y-6 text-sm text-white"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal SETTING -->
    <div id="settings-modal" class="fixed inset-0 z-[150] bg-black/95 backdrop-blur-2xl flex items-center justify-center p-4 hidden no-print text-white">
        <div class="glass-card max-w-5xl w-full rounded-[3rem] p-12 max-h-[90vh] overflow-y-auto custom-scrollbar border border-white/10 shadow-2xl">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h3 class="text-4xl font-black uppercase tracking-tighter">SETTING PANEL</h3>
                    <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-2 italic">Akses Owner PlayStation</p>
                </div>
                <button id="btn-close-settings-modal" class="p-4 bg-slate-800 rounded-2xl hover:bg-rose-600 transition shadow-lg">✕</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <div class="space-y-10">
                    <!-- User Management -->
                    <div class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 shadow-inner">
                        <h4 class="text-xs font-black text-blue-400 uppercase tracking-widest mb-8 flex items-center gap-3 italic underline underline-offset-8">User Control</h4>
                        <div id="settings-users-list" class="space-y-4 mb-10 text-white"></div>
                        <div class="bg-black/30 p-6 rounded-3xl border border-white/5">
                            <h5 class="text-[10px] font-black mb-4 uppercase text-slate-500 tracking-tighter">Tambah Akses</h5>
                            <div class="space-y-4">
                                <input type="text" id="new-user-name" placeholder="Nama" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm text-white">
                                <input type="password" id="new-user-pin" placeholder="PIN" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm text-white">
                                <select id="new-user-role" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm font-bold text-white">
                                    <option value="kasir">Kasir</option>
                                    <option value="owner">Owner</option>
                                </select>
                                <button id="btn-add-user-action" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition">Daftar User</button>
                            </div>
                        </div>
                    </div>

                    <!-- Unit Management -->
                    <div class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 shadow-inner">
                        <h4 class="text-xs font-black text-emerald-400 uppercase tracking-widest mb-8 flex items-center gap-3 italic underline underline-offset-8">Daftar Unit TV</h4>
                        <div id="settings-stations-list" class="space-y-4 mb-10 text-white"></div>
                        <div class="bg-black/30 p-6 rounded-3xl border border-white/5">
                            <h5 class="text-[10px] font-black mb-4 uppercase text-slate-500 tracking-tighter">Unit TV Baru</h5>
                            <div class="space-y-4">
                                <input type="text" id="new-station-name" placeholder="Nama TV" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm text-white">
                                <select id="new-station-type" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm font-bold text-white">
                                    <option value="PS3">PlayStation 3 (8K)</option>
                                    <option value="PS4">PlayStation 4 (10K)</option>
                                </select>
                                <button id="btn-add-station-action" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition">Tambah Unit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Management -->
                <div class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 shadow-inner">
                    <h4 class="text-xs font-black text-orange-400 uppercase tracking-widest mb-8 flex items-center gap-3 italic underline underline-offset-8">Daftar Menu</h4>
                    <div id="settings-menu-list" class="space-y-3 mb-10 text-white"></div>
                    <div class="bg-black/30 p-6 rounded-3xl border border-white/5">
                        <h5 class="text-[10px] font-black mb-4 uppercase text-slate-500 tracking-widest">Tambah Menu</h5>
                        <div class="space-y-4">
                            <input type="text" id="new-menu-name" placeholder="Nama Menu" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm text-white">
                            <input type="number" id="new-menu-price" placeholder="Harga" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 outline-none text-sm font-mono font-bold text-white">
                            <button id="btn-add-menu-action" class="w-full py-4 bg-orange-600 hover:bg-orange-500 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition">Masukkan Menu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals Utility -->
    <div id="time-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 hidden no-print">
        <div class="glass-card max-w-sm w-full rounded-[2.5rem] p-10 text-white border border-white/5 shadow-2xl text-center">
            <h3 class="text-2xl font-black mb-8 uppercase tracking-tighter">Buka Billing</h3>
            <div class="space-y-6 text-black">
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn-time-preset py-4 rounded-2xl bg-slate-800 font-bold hover:bg-slate-700 transition text-white" data-m="60">1 Jam</button>
                    <button class="btn-time-preset py-4 rounded-2xl bg-slate-800 font-bold hover:bg-slate-700 transition text-white" data-m="120">2 Jam</button>
                    <button class="btn-time-preset col-span-2 py-4 rounded-2xl bg-emerald-600/20 text-emerald-400 font-black border border-emerald-500/20 hover:bg-emerald-600/30 transition uppercase text-xs" data-m="0">Mode Argo</button>
                </div>
                <div class="grid grid-cols-2 gap-3 text-white">
                    <input type="number" id="h-input" placeholder="Jam" class="w-full bg-slate-900 border border-white/10 rounded-2xl py-4 text-center font-bold text-xl text-white outline-none">
                    <input type="number" id="m-input" placeholder="Min" class="w-full bg-slate-900 border border-white/10 rounded-2xl py-4 text-center font-bold text-xl text-white outline-none">
                </div>
                <div class="flex gap-4 pt-4">
                    <button id="btn-close-billing-modal" class="flex-1 py-4 bg-slate-800 rounded-2xl font-bold hover:bg-rose-600 transition text-xs uppercase text-white">Batal</button>
                    <button id="btn-confirm-start-billing" class="flex-1 py-4 bg-blue-600 rounded-2xl font-black shadow-lg shadow-blue-500/20 text-xs uppercase text-white">Mulai</button>
                </div>
            </div>
        </div>
    </div>

    <div id="station-picker-modal" class="fixed inset-0 z-[110] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 hidden no-print text-white">
        <div class="glass-card max-w-md w-full rounded-[2.5rem] p-10 text-center border border-white/10 shadow-2xl">
            <h3 class="text-2xl font-black mb-2 uppercase tracking-tight">Pesan Untuk Unit</h3>
            <p id="picker-info-label" class="text-slate-400 text-[10px] mb-8 uppercase font-bold italic tracking-widest"></p>
            <div class="grid grid-cols-2 gap-4 mb-8" id="picker-list-area"></div>
            <button id="btn-cancel-order-picker" class="w-full py-4 rounded-2xl bg-slate-800 font-bold hover:bg-rose-600 transition uppercase text-xs">Tutup</button>
        </div>
    </div>

    <div id="receipt-modal" class="fixed inset-0 z-[150] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 hidden no-print">
        <div class="receipt-paper w-full max-w-[340px] p-10 rounded-sm mx-auto my-10 shadow-2xl animate-in slide-in-from-bottom-10 duration-500 text-black">
            <div id="receipt-print-area" class="text-[11px] leading-tight font-mono"></div>
            <div class="flex gap-3 mt-10 no-print">
                <button onclick="window.print()" class="flex-1 py-4 bg-slate-200 text-black font-black uppercase text-[10px]">CETAK</button>
                <button id="btn-finalize-transaction" class="flex-1 py-4 bg-black text-white font-black uppercase text-[10px] hover:bg-zinc-800 transition">Selesai</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'asyrafuwais-pos-v8';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- GLOBAL STATE ---
        let stations = [];
        let cafeMenu = [];
        let users = [];
        let activeStationId = null;
        let lastBilledStation = null;
        let currentDraftOrder = null;
        let currentUserData = null; 

        // --- AUTH BOOTSTRAP (Rule 3) ---
        const startAuth = async () => {
            if (!auth.currentUser) {
                if (initialToken) await signInWithCustomToken(auth, initialToken);
                else await signInAnonymously(auth);
            }
        };

        // --- SYNC ENGINE ---
        async function startCloudSync() {
            await startAuth();
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stations'), (snap) => {
                        const data = [];
                        snap.forEach(d => data.push({ fid: d.id, ...d.data() }));
                        stations = data.sort((a,b) => a.id - b.id);
                        const label = document.getElementById('connection-label');
                        if(label) label.textContent = "ONLINE & SYNCED";
                        renderStations();
                        renderSettingsStations();
                    });

                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'cafe_menu'), (snap) => {
                        const data = [];
                        snap.forEach(d => data.push({ fid: d.id, ...d.data() }));
                        cafeMenu = data;
                        renderCafeMenu();
                        renderSettingsMenu();
                    });

                    if(currentUserData?.role === 'owner') {
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                            const data = [];
                            snap.forEach(d => data.push({ fid: d.id, ...d.data() }));
                            users = data;
                            renderSettingsUsers();
                        });
                    }
                }
            });
        }

        // --- CORE PROFESSIONAL FUNCTIONS ---
        window.attemptLogin = async () => {
            const pinInput = document.getElementById('login-pin');
            const pin = pinInput.value;
            if(!pin) return;
            await startAuth();
            const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            let found = null;
            if(usersSnap.empty && pin === "1234") {
                found = { name: "Root Admin", role: "owner", pin: "1234" };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', `user-${Date.now()}`), found);
            } else {
                usersSnap.forEach(d => { if(d.data().pin === pin) found = { fid: d.id, ...d.data() }; });
            }
            if (found) {
                currentUserData = found;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-info-display').textContent = `User: ${found.name} (${found.role.toUpperCase()})`;
                if(found.role === 'owner') document.getElementById('btn-open-settings').classList.remove('hidden');
                startCloudSync();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        // --- ATOMIC CLICK DELEGATION ---
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-atomic-action]');
            if (!btn) return;
            
            const action = btn.getAttribute('data-atomic-action');
            const fid = btn.getAttribute('data-fid');
            const id = btn.getAttribute('data-id');

            try {
                if (action === 'delete-station' && confirm("Hapus Unit ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stations', fid));
                } else if (action === 'delete-menu' && confirm("Hapus Item Menu ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cafe_menu', fid));
                } else if (action === 'delete-user' && confirm("Hapus User?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', fid));
                } 
                else if (action === 'edit-station') {
                    const st = stations.find(x => x.fid === fid);
                    const newName = prompt("Nama Unit Baru:", st.name);
                    if (newName) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stations', fid), { name: newName });
                } else if (action === 'edit-menu') {
                    const m = cafeMenu.find(x => x.fid === fid);
                    const nName = prompt("Nama Menu Baru:", m.name);
                    const nPrice = prompt("Harga Baru:", m.price);
                    if (nName && nPrice) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cafe_menu', fid), { name: nName, price: parseInt(nPrice) });
                }
                else if (action === 'open-billing') {
                    activeStationId = parseInt(id);
                    document.getElementById('time-modal').classList.remove('hidden');
                } else if (action === 'stop-billing') {
                    processBillingStop(parseInt(id));
                } else if (action === 'start-order') {
                    handleMenuOrder(parseInt(btn.getAttribute('data-index')));
                } else if (action === 'finalize-order-tv') {
                    commitOrderToCloud(fid);
                } else if (action === 'adjust-qty-internal') {
                    const idx = parseInt(btn.getAttribute('data-index'));
                    const d = parseInt(btn.getAttribute('data-delta'));
                    cafeMenu[idx].qty = Math.max(1, (cafeMenu[idx].qty || 1) + d);
                    renderCafeMenu();
                }
            } catch (err) { alert("Sistem Error: " + err.message); }
        });

        // --- UI RENDER ENGINE ---
        function renderStations() {
            const container = document.getElementById('stations-display-grid');
            if(!container) return;
            const now = Date.now();
            container.innerHTML = stations.map(s => {
                let elapsed = 0;
                if(s.isActive && s.startTime) {
                    const start = s.startTime.toMillis ? s.startTime.toMillis() : s.startTime;
                    elapsed = Math.floor((now - start) / 1000);
                }
                let timeDisplay = s.isActive ? (s.isTimed ? formatTime(Math.max(0, s.targetSeconds - elapsed)) : formatTime(elapsed)) : "00:00:00";
                const rate = s.type === 'PS3' ? 8000 : 10000;
                const rentCost = Math.floor((Math.max(elapsed, 60) / 3600) * rate);
                const foodCost = (s.orders || []).reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
                
                return `
                <div class="glass-card rounded-[2.5rem] p-8 transition-all duration-300 ${s.isActive ? 'ps-active border-blue-500/40' : 'opacity-80'} shadow-xl">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2.5 py-1 rounded-xl text-[8px] font-black text-white ${s.type === 'PS3' ? 'badge-ps3' : 'badge-ps4'} shadow-lg uppercase">${s.type}</span>
                                <h3 class="text-lg font-black text-white tracking-tight uppercase">${s.name}</h3>
                            </div>
                            <span class="text-[9px] font-bold text-slate-500 uppercase italic tracking-widest">${s.isActive ? (s.isTimed ? 'Timed' : 'Argo') : 'Sedia'}</span>
                        </div>
                        <p class="text-4xl font-mono font-black text-blue-400">${timeDisplay}</p>
                    </div>
                    <div class="py-5 border-y border-white/5 mb-4 text-white font-mono">
                        <p class="text-[10px] uppercase font-black mb-1 opacity-70 tracking-widest">Billing Berjalan</p>
                        <p class="text-3xl font-black argo-text">Rp ${formatNumber(rentCost + foodCost)}</p>
                    </div>
                    ${s.isActive && s.orders && s.orders.length > 0 ? `
                        <div class="mt-4 space-y-2 bg-black/30 p-4 rounded-2xl border border-white/5 shadow-inner">
                            ${s.orders.map(o => `<div class="flex justify-between text-[11px] text-slate-300 font-mono border-b border-white/5 pb-1 mb-1 last:border-0 italic"><span>${o.name} <b class="text-blue-400">x${o.qty}</b></span><span>${formatNumber(o.price * o.qty)}</span></div>`).join('')}
                        </div>
                    ` : ''}
                    <button data-atomic-action="${s.isActive ? 'stop-billing' : 'open-billing'}" data-id="${s.id}" class="w-full mt-8 py-4 ${s.isActive ? 'bg-rose-600/20 text-rose-500 border border-rose-500/20' : 'bg-blue-600 text-white shadow-lg'} rounded-2xl font-black uppercase text-[11px] tracking-widest transition active:scale-95">
                        ${s.isActive ? 'TAGIH & SELESAI' : 'BUKA BILLING'}
                    </button>
                </div>`;
            }).join('');
        }

        function renderCafeMenu() {
            const cont = document.getElementById('menu-display-list');
            if(!cont) return;
            cont.innerHTML = cafeMenu.map((m, i) => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-3xl border border-white/5 hover:border-white/10 transition group shadow-sm">
                    <div class="flex-1"><p class="font-bold text-white text-sm tracking-tight uppercase">${m.name}</p><p class="text-[10px] text-emerald-400 font-black mt-1">Rp ${formatNumber(m.price)}</p></div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center bg-slate-900 rounded-2xl p-1 border border-white/10">
                            <button data-atomic-action="adjust-qty-internal" data-index="${i}" data-delta="-1" class="w-8 h-8 flex items-center justify-center text-white font-black hover:text-blue-400 transition">-</button>
                            <span class="w-8 text-center text-xs text-blue-400 font-black">${m.qty || 1}</span>
                            <button data-atomic-action="adjust-qty-internal" data-index="${i}" data-delta="1" class="w-8 h-8 flex items-center justify-center text-white font-black hover:text-blue-400 transition">+</button>
                        </div>
                        <button data-atomic-action="start-order" data-index="${i}" class="bg-blue-600 p-3 rounded-2xl text-white font-black hover:bg-blue-500 shadow-lg active:scale-90 transition">➕</button>
                    </div>
                </div>`).join('');
        }

        function renderSettingsStations() {
            const list = document.getElementById('settings-stations-list');
            if(!list) return;
            list.innerHTML = stations.map(s => `
                <div class="flex justify-between items-center p-5 bg-white/5 rounded-3xl border border-white/10 shadow-xl">
                    <div class="flex items-center gap-4">
                        <span class="px-3 py-1.5 rounded-xl text-[9px] font-black text-white ${s.type === 'PS3' ? 'badge-ps3' : 'badge-ps4'} shadow-lg">${s.type}</span>
                        <p class="font-black text-white tracking-tight uppercase">${s.name}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-atomic-action="edit-station" data-fid="${s.fid}" class="px-4 py-2 bg-amber-500/20 text-amber-500 rounded-xl text-[9px] font-black uppercase hover:bg-amber-500 hover:text-white transition">Edit</button>
                        <button data-atomic-action="delete-station" data-fid="${s.fid}" class="px-4 py-2 bg-rose-600/10 text-rose-500 rounded-xl text-[10px] font-black uppercase hover:bg-rose-600 transition">Hapus</button>
                    </div>
                </div>`).join('');
        }

        function renderSettingsMenu() {
            const list = document.getElementById('settings-menu-list');
            if(!list) return;
            list.innerHTML = cafeMenu.map(m => `
                <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5 shadow-xl text-white">
                    <p class="font-bold text-white text-sm uppercase">${m.name}</p>
                    <div class="flex gap-2">
                        <button data-atomic-action="edit-menu" data-fid="${m.fid}" class="px-3 py-2 bg-amber-500/20 text-amber-500 rounded-xl text-[9px] font-black uppercase">Edit</button>
                        <button data-atomic-action="delete-menu" data-fid="${m.fid}" class="px-4 py-2 bg-rose-600/10 text-rose-500 rounded-xl text-[10px] font-black uppercase">Hapus</button>
                    </div>
                </div>`).join('');
        }

        function renderSettingsUsers() {
            const list = document.getElementById('settings-users-list');
            if(!list) return;
            list.innerHTML = users.map(u => `
                <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div><p class="font-bold uppercase text-xs">${u.name}</p><p class="text-slate-400 text-[10px] uppercase">${u.role}</p></div>
                    <button data-atomic-action="delete-user" data-fid="${u.fid}" class="px-4 py-2 bg-rose-600/20 text-rose-500 rounded-xl text-[10px] font-black uppercase transition">Hapus</button>
                </div>`).join('');
        }

        // --- BILLING LOGIC ---
        async function processBillingStop(id) {
            const s = stations.find(st => st.id === id);
            const start = s.startTime.toMillis ? s.startTime.toMillis() : Date.now();
            const elapsed = Math.floor((Date.now() - start) / 1000);
            const rate = s.type === 'PS3' ? 8000 : 10000;
            const timeCost = Math.floor((Math.max(elapsed, 60) / 3600) * rate);
            const foodCost = (s.orders || []).reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
            lastBilledStation = { ...s, elapsed, total: timeCost + foodCost, timeCost, foodCost };

            const panel = document.getElementById('billing-summary-card');
            panel.classList.remove('hidden');
            document.getElementById('summary-render-area').innerHTML = `
                <div class="bg-white/5 p-6 rounded-3xl border border-white/10 text-white shadow-inner">
                    <div class="flex justify-between mb-2"><span>Unit Console</span><span class="font-bold text-lg">${s.name}</span></div>
                    <div class="flex justify-between"><span>Durasi Main</span><span class="font-bold text-blue-400 font-mono text-2xl">${formatTime(elapsed)}</span></div>
                </div>
                <table class="w-full text-xs text-white">
                    <tr class="border-b border-white/5 font-bold"><td class="py-2 text-slate-400 italic">Rental PS (${s.type})</td><td class="text-right">Rp ${formatNumber(timeCost)}</td></tr>
                    ${s.orders.map(o => `<tr><td class="py-2 pl-3 text-slate-400 italic font-bold">- ${o.name} x${o.qty}</td><td class="text-right text-emerald-400 font-mono">Rp ${formatNumber(o.price * o.qty)}</td></tr>`).join('')}
                </table>
                <div class="pt-6 border-t border-dashed border-white/20 flex justify-between items-center text-white">
                    <span class="text-xs font-black uppercase text-slate-500">TOTAL BAYAR</span>
                    <span class="text-3xl font-black text-emerald-400 font-mono tracking-tighter">Rp ${formatNumber(timeCost + foodCost)}</span>
                </div>
                <button id="btn-do-checkout-final" class="w-full py-5 mt-8 bg-emerald-600 rounded-[1.5rem] font-black uppercase text-white shadow-xl hover:bg-emerald-500 transition active:scale-95 shadow-emerald-600/20">LUNAS & CETAK STRUK</button>
            `;
            document.getElementById('btn-do-checkout-final').onclick = commitFinalTransaction;
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        async function commitFinalTransaction() {
            const { name, elapsed, total, timeCost, type, orders, fid } = lastBilledStation;
            const d = new Date().toLocaleString('id-ID');
            document.getElementById('receipt-print-area').innerHTML = `
                <div class="text-center mb-8 font-bold uppercase"><h4 class="text-[15px]">ASYRAFUWAIS PLAYSTATION</h4><p class="text-[9px]">Sistem Kasir Cloud PRO</p><p>--------------------------------</p></div>
                <div class="space-y-1 mb-6 text-[10px]">
                    <div class="flex justify-between"><span>TANGGAL :</span><span>${d}</span></div>
                    <div class="flex justify-between"><span>UNIT    :</span><span>${name}</span></div>
                    <div class="flex justify-between"><span>DURASI  :</span><span>${formatTime(elapsed)}</span></div>
                </div>
                <table class="w-full text-[10px] mb-8">
                    <tr><td class="py-1">SEWA PS (${type})</td><td class="text-right">${formatNumber(timeCost)}</td></tr>
                    ${orders.map(o => `<tr><td class="py-1">${o.name} x${o.qty}</td><td class="text-right">${formatNumber(o.price * o.qty)}</td></tr>`).join('')}
                </table>
                <div class="border-t border-black border-dashed pt-4 flex justify-between font-bold text-[14px] uppercase tracking-tighter"><span>TOTAL</span><span>Rp ${formatNumber(total)}</span></div>
                <div class="text-center mt-12 uppercase font-black text-[13px] border-2 border-black p-3">LUNAS</div>
            `;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stations', fid), { isActive: false, startTime: null, orders: [] });
            document.getElementById('receipt-modal').classList.remove('hidden');
            document.getElementById('billing-summary-card').classList.add('hidden');
            setTimeout(() => window.print(), 300);
        }

        function handleMenuOrder(idx) {
            currentDraftOrder = { ...cafeMenu[idx], qty: cafeMenu[idx].qty || 1 };
            const active = stations.filter(s => s.isActive);
            if(!active.length) return alert("Peringatan: Aktifkan Unit TV dulu bro!");
            document.getElementById('picker-info-label').textContent = `Kirim ${currentDraftOrder.qty}x ${currentDraftOrder.name} ke:`;
            document.getElementById('picker-list-area').innerHTML = active.map(s => `<button data-atomic-action="finalize-order-tv" data-fid="${s.fid}" class="p-5 bg-slate-800 rounded-3xl text-white font-bold border border-white/5 hover:bg-blue-600 transition shadow-xl uppercase text-xs">${s.name}</button>`).join('');
            document.getElementById('station-picker-modal').classList.remove('hidden');
        }

        async function commitOrderToCloud(fid) {
            const s = stations.find(st => st.fid === fid);
            const orders = [...(s.orders || [])];
            const ex = orders.find(o => o.name === currentDraftOrder.name);
            if(ex) ex.qty += currentDraftOrder.qty;
            else orders.push({ name: currentDraftOrder.name, price: currentDraftOrder.price, qty: currentDraftOrder.qty });
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stations', fid), { orders });
            document.getElementById('station-picker-modal').classList.add('hidden');
        }

        // --- BUTTON HANDLERS ---
        const initUI = () => {
            const el = (id) => document.getElementById(id);
            if(el('btn-login-action')) el('btn-login-action').onclick = () => window.attemptLogin();
            if(el('btn-open-settings')) el('btn-open-settings').onclick = () => el('settings-modal').classList.remove('hidden');
            if(el('btn-logout-trigger')) el('btn-logout-trigger').onclick = async () => { await signOut(auth); location.reload(); };
            if(el('btn-close-settings-modal')) el('btn-close-settings-modal').onclick = () => el('settings-modal').classList.add('hidden');
            if(el('btn-close-billing-modal')) el('btn-close-billing-modal').onclick = () => el('time-modal').classList.add('hidden');
            if(el('btn-cancel-order-picker')) el('btn-cancel-order-picker').onclick = () => el('station-picker-modal').classList.add('hidden');
            if(el('btn-finalize-transaction')) el('btn-finalize-transaction').onclick = () => { el('receipt-modal').classList.add('hidden'); lastBilledStation = null; };

            if(el('btn-add-station-action')) el('btn-add-station-action').onclick = async () => {
                const n = el('new-station-name').value; const t = el('new-station-type').value;
                if(!n) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stations', `tv-${Date.now()}`), { id: Date.now(), name: n, type: t, isActive: false, orders: [] });
                el('new-station-name').value = "";
            };

            if(el('btn-add-menu-action')) el('btn-add-menu-action').onclick = async () => {
                const n = el('new-menu-name').value; const p = parseInt(el('new-menu-price').value);
                if(n && p) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cafe_menu', `menu-${Date.now()}`), { name: n, price: p });
                    el('new-menu-name').value = ""; el('new-menu-price').value = "";
                }
            };

            if(el('btn-add-user-action')) el('btn-add-user-action').onclick = async () => {
                const n = el('new-user-name').value; const p = el('new-user-pin').value; const r = el('new-user-role').value;
                if(n && p) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', `user-${Date.now()}`), { name: n, pin: p, role: r });
                    el('new-user-name').value = ""; el('new-user-pin').value = "";
                }
            };

            document.querySelectorAll('.btn-time-preset').forEach(b => {
                b.onclick = () => startBillingAtomic(parseInt(b.getAttribute('data-m')));
            });

            if(el('btn-confirm-start-billing')) el('btn-confirm-start-billing').onclick = () => {
                const h = parseInt(el('h-input').value) || 0; const m = parseInt(el('m-input').value) || 0;
                startBillingAtomic((h * 60) + m);
            };
        };

        async function startBillingAtomic(min) {
            const s = stations.find(st => st.id === activeStationId);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stations', s.fid), {
                isActive: true, isTimed: min > 0, startTime: serverTimestamp(), targetSeconds: min * 60, orders: []
            });
            document.getElementById('time-modal').classList.add('hidden');
        }

        function formatTime(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60; return [h,m,sec].map(v => v < 10 ? "0"+v : v).join(":"); }
        function formatNumber(n) { return new Intl.NumberFormat('id-ID').format(n); }

        // --- STARTUP ---
        initUI();
        startAuth();
        setInterval(() => { if(stations.length) renderStations(); }, 1000);
        (function updateClock() { document.getElementById('digital-clock').textContent = new Date().toLocaleTimeString('id-ID'); setTimeout(updateClock, 1000); })();
    </script>
</body>
</html>